<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moderator Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .nav-link.active {
            background-color: #F5F3FF; /* purple-50 */
            color: #6D28D9; /* purple-700 */
            font-weight: 600;
        }
        .nav-link.active svg {
            color: #6D28D9; /* purple-700 */
        }
        /* Style for date input placeholder */
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0.5;
        }
        /* Modal styles */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }
        /* UPDATED: Increased specificity to override Tailwind defaults */
        .status-btn.status-btn-active-present { background-color: #10B981; color: white; border-color: #10B981; } /* Emerald 500 */
        .status-btn.status-btn-active-absent { background-color: #EF4444; color: white; border-color: #EF4444; }  /* Red 500 */
        .status-btn.status-btn-active-late { background-color: #F59E0B; color: white; border-color: #F59E0B; }    /* Amber 500 */
        .status-btn.status-btn-active-excused { background-color: #3B82F6; color: white; border-color: #3B82F6; } /* Blue 500 */
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="flex h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-white shadow-lg flex-shrink-0 hidden md:flex flex-col">
            <div class="p-6 border-b">
                <div class="flex items-center space-x-3">
                    <svg class="h-10 w-10 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h12A2.25 2.25 0 0020.25 14.25V5.25A2.25 2.25 0 0018 3H6.75a2.25 2.25 0 00-2.25 2.25v.093c.352-.011.707-.017 1.06-.017h1.438c.353 0 .707.006 1.06.017v-.093a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.093c.352-.011.707-.017 1.06-.017h1.44c.353 0 .707.006 1.06.017v-.093a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.093c.352-.011.707-.017 1.06-.017h1.44a2.25 2.25 0 012.25 2.25v1.5a2.25 2.25 0 01-2.25 2.25h-1.44a12.93 12.93 0 01-1.06.017v-.093a.75.75 0 00-.75-.75h-.01a.75.75 0 00-.75.75v.093c-.353.011-.707-.017-1.06.017h-1.439a12.93 12.93 0 01-1.06-.017v-.093a.75.75 0 00-.75-.75h-.01a.75.75 0 00-.75.75v.093c-.353.011-.707-.017-1.06.017H6a2.25 2.25 0 01-2.25-2.25v-1.5A2.25 2.25 0 016 9h1.438c.353 0 .707.006 1.06.017v-.093a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.093c.352-.011.707-.017 1.06-.017h1.44c.353 0 .707.006 1.06.017v-.093a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.093c.352-.011.707-.017 1.06-.017H18a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 18V3m0 0A2.25 2.25 0 016.75 3H18a2.25 2.25 0 012.25 2.25v.25a.75.75 0 01-1.5 0V5.25a.75.75 0 00-.75-.75H6.75a.75.75 0 00-.75.75v.25a.75.75 0 01-1.5 0V3z" />
                    </svg>
                    <span class="text-xl font-bold">Holistiq EMS</span>
                </div>
            </div>
            <nav class="mt-6 flex-1 px-4 space-y-2">
                <a href="#" id="nav-dashboard" class="nav-link flex items-center px-4 py-2.5 text-gray-700 hover:bg-gray-100 rounded-lg">
                    <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
                    <span class="ml-3">Dashboard</span>
                </a>
                <a href="#" id="nav-attendance" class="nav-link flex items-center px-4 py-2.5 text-gray-700 hover:bg-gray-100 rounded-lg">
                    <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 4.5l7.5 7.5-7.5 7.5m-6-15l7.5 7.5-7.5 7.5" /></svg>
                    <span class="ml-3">Attendance</span>
                </a>
                <a href="#" id="nav-calendar" class="nav-link flex items-center px-4 py-2.5 text-gray-700 hover:bg-gray-100 rounded-lg">
                    <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18" /></svg>
                    <span class="ml-3">Calendar</span>
                </a>
            </nav>
            <div class="mt-auto p-6 border-t">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center font-bold text-gray-700">JD</div>
                    <div>
                        <p class="font-semibold text-gray-800">John Doe</p>
                        <p class="text-sm text-gray-500">Moderator</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 sm:p-8 md:p-10 overflow-y-auto">
            <div class="max-w-7xl mx-auto">
                <!-- View Containers -->
                <div id="view-dashboard"></div>
                <div id="view-attendance" class="hidden"></div>
                <div id="view-calendar" class="hidden"></div>
            </div>
        </main>
    </div>

    <!-- Attendance Modal -->
    <div id="attendance-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-backdrop fixed inset-0" onclick="closeAttendanceModal()"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col transform scale-95 transition-transform">
            <!-- Modal Header -->
            <div class="p-6 border-b flex justify-between items-center">
                <div>
                    <h2 id="modal-session-title" class="text-2xl font-bold text-gray-900"></h2>
                    <p id="modal-session-details" class="text-gray-500 mt-1"></p>
                </div>
                <div class="relative">
                    <button onclick="toggleDropdown('session-download-dropdown')" class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-semibold">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                        <span>Download</span>
                    </button>
                    <div id="session-download-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Download as CSV</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Download as PDF</a>
                    </div>
                </div>
            </div>
            <!-- Modal Tabs -->
            <div class="p-4 border-b">
                <div class="flex space-x-2">
                    <button id="manual-entry-tab" class="px-4 py-2 text-sm font-semibold rounded-lg">Manual Entry</button>
                    <button id="qr-code-tab" class="px-4 py-2 text-sm font-semibold rounded-lg">QR Code</button>
                </div>
            </div>
            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto">
                <!-- Manual Entry View -->
                <div id="manual-entry-view" class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <input type="text" placeholder="Search students..." class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg">
                        <div class="flex space-x-2">
                            <button class="px-3 py-2 text-xs font-semibold bg-gray-100 hover:bg-gray-200 rounded-md">Mark all Present</button>
                            <button class="px-3 py-2 text-xs font-semibold bg-gray-100 hover:bg-gray-200 rounded-md">Mark all Absent</button>
                        </div>
                    </div>
                    <div id="student-list" class="space-y-2">
                        <!-- Student rows will be injected here -->
                    </div>
                </div>
                <!-- QR Code View -->
                <div id="qr-code-view" class="hidden p-6 flex flex-col items-center justify-center h-full">
                    <h3 class="text-xl font-bold text-center">Scan to Mark Attendance</h3>
                    <p class="text-gray-500 text-center mt-2 mb-6">Students can scan this code with their device to be marked as present.</p>
                    <div id="qrcode-container" class="bg-white p-4 rounded-lg shadow-md"></div>
                    <button class="mt-6 px-4 py-2 text-sm font-semibold bg-gray-100 hover:bg-gray-200 rounded-md flex items-center space-x-2">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991 0l-3.182-3.182a8.25 8.25 0 00-11.667 0l3.182 3.182z" /></svg>
                        <span>Regenerate Code</span>
                    </button>
                </div>
            </div>
            <!-- Modal Footer -->
            <div class="p-6 bg-gray-50 border-t flex justify-end space-x-3">
                <button onclick="closeAttendanceModal()" class="px-6 py-2 text-sm font-semibold bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button class="px-6 py-2 text-sm font-semibold bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save Attendance</button>
            </div>
        </div>
    </div>

    <script>
        // --- MOCK DATA ---
        const allSessionsData = [ { id: 1, name: 'Robotics Club', time: '3:00 PM', date: '2025-07-18', location: 'Tech Lab 1', students: 15, attendance: 'completed' }, { id: 2, name: 'Debate Team Practice', time: '3:30 PM', date: '2025-07-18', location: 'Room 204', students: 22, attendance: 'completed' }, { id: 3, name: 'Photography Club', time: '4:00 PM', date: '2025-07-19', location: 'Art Studio', students: 18, attendance: 'pending' }, { id: 4, name: 'Advanced Chess Strategy', time: '4:00 PM', date: '2025-07-17', location: 'Library', students: 12, attendance: 'pending' }, { id: 5, name: 'Creative Writing Workshop', time: '4:30 PM', date: '2025-07-17', location: 'Room 301', students: 16, attendance: 'pending' }, { id: 6, name: 'Robotics Club', time: '3:00 PM', date: '2025-07-25', location: 'Tech Lab 1', students: 15, attendance: 'pending' }, ];
        const studentRoster = [ { id: 's1', name: 'Amelia Johnson' }, { id: 's2', name: 'Benjamin Carter' }, { id: 's3', name: 'Sophia Rodriguez' }, { id: 's4', name: 'Liam Goldberg' }, { id: 's5', name: 'Olivia Chen' }, { id: 's6', name: 'Noah Patel' }, ];
        
        // --- DOM ELEMENTS ---
        const navLinks = { dashboard: document.getElementById('nav-dashboard'), attendance: document.getElementById('nav-attendance'), calendar: document.getElementById('nav-calendar'),};
        const views = { dashboard: document.getElementById('view-dashboard'), attendance: document.getElementById('view-attendance'), calendar: document.getElementById('view-calendar'),};
        const attendanceModal = document.getElementById('attendance-modal');

        // --- NAVIGATION LOGIC ---
        function switchView(viewName) {
            Object.values(views).forEach(view => {
                view.classList.add('hidden');
            });
            Object.values(navLinks).forEach(link => link.classList.remove('active'));
            
            views[viewName].classList.remove('hidden');
            navLinks[viewName].classList.add('active');

            // Build the view's content
            if (viewName === 'dashboard') buildDashboardView();
            else if (viewName === 'attendance') buildAttendanceView();
            else if (viewName === 'calendar') buildCalendarView();
        }
        
        // --- HTML BUILDERS ---
        function buildDashboardView() {
            views.dashboard.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-900">Moderator Dashboard</h1>
                <p class="text-gray-600 mt-1">Welcome back, John. Here's what's on your plate today.</p>
                <div class="mt-8 flex justify-end">
                    <div class="relative">
                        <button onclick="toggleDropdown('dashboard-download-dropdown')" class="flex items-center space-x-2 bg-white border border-gray-300 px-4 py-2 rounded-lg text-sm font-semibold">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                            <span>Download Attendance</span>
                        </button>
                        <div id="dashboard-download-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-10 border">
                            <div class="p-2 text-sm font-semibold text-gray-500 border-b">Download by timeframe</div>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">This Day</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">This Week</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">This Month</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">This Term</a>
                             <div class="p-2 text-sm font-semibold text-gray-500 border-t mt-1">Download as</div>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">CSV</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">PDF</a>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Action Items</h2>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="font-semibold text-lg">Pending Attendance</h3>
                            <span id="pending-attendance-count" class="bg-red-100 text-red-800 text-sm font-bold px-2.5 py-1 rounded-full"></span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">Sessions from previous days that need attendance marked.</p>
                        <div id="pending-attendance-list" class="mt-4 space-y-3"></div>
                    </div>
                </div>
                <div class="mt-10">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Upcoming Sessions</h2>
                    <div id="upcoming-sessions-list" class="space-y-4"></div>
                </div>`;
            renderDashboard();
        }

        function buildAttendanceView() {
            views.attendance.innerHTML = `
                <div class="flex justify-between items-center mb-8">
                    <div class="flex items-center space-x-3">
                        <h1 class="text-3xl font-bold text-gray-900">Sessions</h1>
                        <span id="att-total-count" class="bg-gray-200 text-gray-800 text-sm font-semibold px-3 py-1 rounded-full"></span>
                    </div>
                     <div class="relative">
                        <button onclick="toggleDropdown('attendance-download-dropdown')" class="flex items-center space-x-2 bg-white border border-gray-300 px-4 py-2 rounded-lg text-sm font-semibold">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                            <span>Download Report</span>
                        </button>
                        <div id="attendance-download-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-10 border">
                            <div class="p-2 text-sm font-semibold text-gray-500 border-b">Download by timeframe</div>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">This Day</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">This Week</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">This Month</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">This Term</a>
                             <div class="p-2 text-sm font-semibold text-gray-500 border-t mt-1">Download as</div>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">CSV</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">PDF</a>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4">
                        <div><label for="att-search-input" class="text-sm font-medium text-gray-700">Search Sessions</label><input type="text" id="att-search-input" placeholder="Search by title..." class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"></div>
                        <div><label for="att-date-input" class="text-sm font-medium text-gray-700">Filter by Date</label><input type="date" id="att-date-input" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-gray-500"></div>
                        <div><label for="att-status-select" class="text-sm font-medium text-gray-700">Status</label><select id="att-status-select" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"><option value="all">Current Sessions</option><option value="pending">Past Sessions</option><option value="completed">Future Sessions</option></select></div>
                    </div>
                </div>
                <div id="attendance-page-list" class="space-y-4"></div>`;
            renderAttendancePage();
            setupAttendanceFilters();
        }

        function buildCalendarView() {
            views.calendar.innerHTML = `<div class="flex items-center justify-between mb-8"><div><h1 class="text-3xl font-bold text-gray-900" id="calendar-month-year"></h1><p class="text-gray-600 mt-1">A monthly overview of all CCA sessions.</p></div><div class="flex items-center space-x-2"><button id="prev-month-btn" class="p-2 rounded-lg hover:bg-gray-100"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"></path></svg></button><button id="next-month-btn" class="p-2 rounded-lg hover:bg-gray-100"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"></path></svg></button></div></div><div class="bg-white p-6 rounded-xl shadow-sm border"><div class="grid grid-cols-7 gap-px text-center text-sm font-semibold text-gray-600 mb-2"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div><div id="calendar-grid" class="grid grid-cols-7 gap-px"></div></div>`;
            renderCalendar();
            setupCalendarControls();
        }

        // --- RENDER FUNCTIONS (Populate content) ---
        function renderDashboard() {
            const pendingAttendanceData = allSessionsData.filter(s => s.attendance === 'pending' && new Date(s.date) < new Date('2025-07-18'));
            const upcomingSessionsData = allSessionsData.filter(s => new Date(s.date) >= new Date('2025-07-18')).slice(0, 3).map(s => ({...s, day: new Date(s.date).toDateString() === new Date('2025-07-18').toDateString() ? 'Today' : 'Tomorrow'}));
            const paCount = document.getElementById('pending-attendance-count');
            const paList = document.getElementById('pending-attendance-list');
            paCount.textContent = pendingAttendanceData.length;
            paList.innerHTML = '';
            if (pendingAttendanceData.length === 0) paList.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">No pending attendance.</p>`;
            else pendingAttendanceData.forEach(item => { paList.innerHTML += `<div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg"><div><p class="font-medium text-sm text-gray-800">${item.name}</p><p class="text-xs text-gray-500">${new Date(item.date).toLocaleDateString()}, ${item.time}</p></div><button onclick='openAttendanceModal(${JSON.stringify(item)})' class="text-sm font-semibold text-purple-700 hover:text-purple-900">Mark Now</button></div>`; });
            const usList = document.getElementById('upcoming-sessions-list');
            usList.innerHTML = '';
            if (upcomingSessionsData.length === 0) usList.innerHTML = `<p class="text-sm text-gray-500 text-center py-8 bg-white rounded-xl border">No upcoming sessions.</p>`;
            else upcomingSessionsData.forEach(session => { usList.innerHTML += `<div class="action-card bg-white p-5 rounded-xl shadow-sm border flex items-center justify-between gap-4 transition-all"><div class="flex items-center gap-4"><div class="bg-purple-100 text-purple-700 rounded-lg p-3 flex flex-col items-center justify-center w-16 h-16"><span class="font-bold text-lg">${session.time.split(':')[0]}</span><span class="text-xs font-medium">${session.time.split(' ')[1]}</span></div><div><p class="font-bold text-lg text-gray-900">${session.name}</p><p class="text-sm text-gray-500 mt-1"><span class="font-semibold">${session.day}</span> &bull; ${session.location}</p></div></div><button onclick='openAttendanceModal(${JSON.stringify(session)})' class="flex-shrink-0 bg-white text-gray-800 px-4 py-2 rounded-lg font-semibold text-sm border border-gray-300 hover:bg-gray-100 transition-colors">View Details</button></div>`; });
        }
        
        function renderAttendancePage() {
            const list = document.getElementById('attendance-page-list');
            const search = document.getElementById('att-search-input').value.toLowerCase();
            const date = document.getElementById('att-date-input').value;
            const status = document.getElementById('att-status-select').value;
            const filteredSessions = allSessionsData.filter(session => {
                const matchesSearch = session.name.toLowerCase().includes(search);
                const matchesDate = !date || session.date === date;
                const matchesStatus = (status === 'all') || (session.attendance === status);
                return matchesSearch && matchesDate && matchesStatus;
            });
            document.getElementById('att-total-count').textContent = `${filteredSessions.length} Total`;
            list.innerHTML = '';
            if (filteredSessions.length === 0) { list.innerHTML = `<p class="text-center text-gray-500 py-10">No sessions match the current filters.</p>`; return; }
            filteredSessions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(session => {
                const isPending = session.attendance === 'pending';
                const cardBorder = isPending ? 'border-red-500 border-2' : 'border-gray-200';
                const buttonText = isPending ? 'Mark Now' : 'View';
                const buttonClass = isPending ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-white text-gray-800 border-gray-300 hover:bg-gray-100 border';
                list.innerHTML += `<div class="bg-white p-5 rounded-xl shadow-sm ${cardBorder} flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                    <div class="flex-grow"><p class="font-bold text-lg text-gray-900">${session.name}</p><p class="text-sm text-gray-500 mt-1">${new Date(session.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} at ${session.time}</p></div>
                    <div class="flex-shrink-0 w-full sm:w-auto flex items-center space-x-2">
                        <button onclick='openAttendanceModal(${JSON.stringify(session)})' class="w-full ${buttonClass} px-4 py-2 rounded-lg font-semibold text-sm transition-colors">${buttonText}</button>
                    </div>
                </div>`;
            });
        }
        
        let currentDate = new Date('2025-07-18');
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const calendarMonthYear = document.getElementById('calendar-month-year');
            const grid = document.getElementById('calendar-grid');
            calendarMonthYear.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
            grid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) { grid.innerHTML += `<div class="border-t border-l border-gray-100"></div>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(year, month, day);
                const isToday = dayDate.toDateString() === new Date('2025-07-18').toDateString();
                const sessionsOnDay = allSessionsData.filter(s => new Date(s.date).toDateString() === dayDate.toDateString());
                let dayHtml = `<div class="border-t border-l border-gray-100 p-2 h-28 flex flex-col"><div class="font-medium ${isToday ? 'bg-purple-600 text-white rounded-full h-7 w-7 flex items-center justify-center' : 'text-gray-700'}">${day}</div><div class="mt-1 text-xs text-left overflow-y-auto">`;
                sessionsOnDay.forEach(session => { dayHtml += `<div class="bg-purple-50 text-purple-700 rounded p-1 mb-1 truncate">${session.name}</div>`; });
                dayHtml += `</div></div>`;
                grid.innerHTML += dayHtml;
            }
        }

        // --- FILTER & CONTROL SETUP ---
        function setupAttendanceFilters() {
            const attSearchInput = document.getElementById('att-search-input');
            const attDateInput = document.getElementById('att-date-input');
            const attStatusSelect = document.getElementById('att-status-select');
            [attSearchInput, attDateInput, attStatusSelect].forEach(el => el.addEventListener('input', renderAttendancePage));
        }
        function setupCalendarControls() {
            document.getElementById('prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            document.getElementById('next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        }
        
        // --- ATTENDANCE MODAL LOGIC ---
        function openAttendanceModal(session) {
            document.getElementById('modal-session-title').textContent = session.name;
            document.getElementById('modal-session-details').textContent = `${new Date(session.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })} at ${session.time}`;
            const studentListEl = document.getElementById('student-list');
            studentListEl.innerHTML = '';
            studentRoster.forEach(student => {
                const studentRow = document.createElement('div');
                studentRow.className = 'student-row flex items-center justify-between p-3 border-b border-gray-100';
                // Buttons now have a `title` attribute for the tooltip on hover
                studentRow.innerHTML = `<div class="flex items-center"><div class="w-8 h-8 bg-gray-200 rounded-full mr-3 flex-shrink-0"></div><span class="font-medium text-sm">${student.name}</span></div>
                    <div class="flex space-x-2">
                        <button title="Present" class="status-btn w-9 h-9 flex items-center justify-center text-sm font-semibold text-gray-600 bg-transparent border-2 border-gray-300 hover:border-gray-500 rounded-full transition-colors" data-status="present">P</button>
                        <button title="Absent" class="status-btn w-9 h-9 flex items-center justify-center text-sm font-semibold text-gray-600 bg-transparent border-2 border-gray-300 hover:border-gray-500 rounded-full transition-colors" data-status="absent">A</button>
                        <button title="Late" class="status-btn w-9 h-9 flex items-center justify-center text-sm font-semibold text-gray-600 bg-transparent border-2 border-gray-300 hover:border-gray-500 rounded-full transition-colors" data-status="late">L</button>
                        <button title="Excused" class="status-btn w-9 h-9 flex items-center justify-center text-sm font-semibold text-gray-600 bg-transparent border-2 border-gray-300 hover:border-gray-500 rounded-full transition-colors" data-status="excused">E</button>
                    </div>`;
                studentListEl.appendChild(studentRow);
            });
            
            studentListEl.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', handleStatusClick);
            });

            attendanceModal.classList.remove('hidden');
            setTimeout(() => attendanceModal.querySelector('.transform').classList.remove('scale-95'), 10);
            switchModalTab('manual');
        }

        function handleStatusClick(event) {
            const clickedButton = event.currentTarget;
            const row = clickedButton.closest('.student-row');
            const status = clickedButton.dataset.status;
            // Clear active state from all buttons in the same row
            row.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('status-btn-active-present', 'status-btn-active-absent', 'status-btn-active-late', 'status-btn-active-excused');
            });
            // Add active state to the clicked button
            if (status === 'present') clickedButton.classList.add('status-btn-active-present');
            else if (status === 'absent') clickedButton.classList.add('status-btn-active-absent');
            else if (status === 'late') clickedButton.classList.add('status-btn-active-late');
            else if (status === 'excused') clickedButton.classList.add('status-btn-active-excused');
        }

        function closeAttendanceModal() {
            attendanceModal.querySelector('.transform').classList.add('scale-95');
            setTimeout(() => attendanceModal.classList.add('hidden'), 200);
        }
        function switchModalTab(tabName) {
            const manualTab = document.getElementById('manual-entry-tab');
            const qrTab = document.getElementById('qr-code-tab');
            const manualView = document.getElementById('manual-entry-view');
            const qrView = document.getElementById('qr-code-view');
            manualTab.classList.remove('bg-purple-100', 'text-purple-700');
            qrTab.classList.remove('bg-purple-100', 'text-purple-700');
            manualView.classList.add('hidden');
            qrView.classList.add('hidden');
            if (tabName === 'manual') { manualTab.classList.add('bg-purple-100', 'text-purple-700'); manualView.classList.remove('hidden'); } 
            else { qrTab.classList.add('bg-purple-100', 'text-purple-700'); qrView.classList.remove('hidden'); generateQRCode(); }
        }
        function generateQRCode() {
            const container = document.getElementById('qrcode-container');
            container.innerHTML = '';
            new QRCode(container, { text: `SESSION_ID:${Math.ceil(Math.random() * 1000)}`, width: 256, height: 256, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
        }

        function toggleDropdown(id) {
            document.getElementById(id).classList.toggle('hidden');
        }
        
        // --- INITIALIZATION ---
        window.onload = () => {
            // Setup modal tab switching
            document.getElementById('manual-entry-tab').addEventListener('click', () => switchModalTab('manual'));
            document.getElementById('qr-code-tab').addEventListener('click', () => switchModalTab('qr'));

            Object.keys(navLinks).forEach(key => { 
                navLinks[key].addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    switchView(key); 
                }); 
            });

            // Set the initial view
            switchView('dashboard');
        };
    </script>

</body>
</html>
